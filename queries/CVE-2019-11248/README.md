# CVE-2019-11248

본 쿼리는 CVE 적용 가능한 버전인 [kubernetes-1.13.7](https://github.com/kubernetes/kubernetes/releases/tag/v1.13.7)에서 1-day 탐지가 가능하도록 작성하였다.

- [kubernetes-1.13.7 LGTM project](https://lgtm.com/projects/g/MobyDick-CodeQLDB/kubernetes-1.13.7/)

참고한 LGTM 예시 쿼리

- [Call to library function](https://github.com/github/codeql-go/blob/main/ql/examples/snippets/calltofunction.ql)
- [Comparison with nil](https://github.com/github/codeql-go/blob/main/ql/examples/snippets/nilcheck.ql)

참고한 Security Lab 문서

- [CodeQL library for Go](https://help.semmle.com/QL/learn-ql/go/introduce-libraries-go.html)

ListenAndServe와 DefaultServeMux 관련

- [Package http - func ListenAndServe](https://golang.org/pkg/net/http/#ListenAndServe)

### What is it?

[본 CVE 패치 시 개발자가 남긴 코멘트](https://github.com/kubernetes/kubernetes/pull/78313#issue-282101814)에 따르면 `DefaultServeMux`를 사용하는 건 전역 변수를 남용하는 것 만큼 안전한 코딩 스타일이 아니다. 따라서 `DefaultServeMux`를 사용하는지 찾는 쿼리를 작성하였다.

`DefaultServeMux`를 사용한다고 하더라도 해당 주소와 포트로 민감한 정보가 유출되어야 취약점이라고 볼 수 있다. 해당 포트로 어떠한 민감한 정보도 오가지 않는다면 무의미하다.

## Query Explanation

### listenandserve.ql

아래는 `listenandserve.ql` 코드이다.

```ql
import go

from Function listenandserve, DataFlow::CallNode call, DataFlow::Node argument, DataFlow::Node nil
where
  listenandserve.hasQualifiedName("net/http", "ListenAndServe") and
  call = listenandserve.getACall() and
  argument = call.getArgument(1) and
  nil = Builtin::nil().getARead() and
  argument = nil
select call, call.getFile()
```

Golang의 `net/http` 패키지에 속하는 `ListenAndServe` 함수를 호출하는 `CallNode` 중 1번째 인자가 `nil`인 것을 찾는다. (인자는 0번째부터 카운트함)

예시:

```go
http.ListenAndServe(":8080", nil)  // YES:)
http.ListenAndServe(":8080", mux)  // NO:(
```

[Golang 공식 문서](https://golang.org/pkg/net/http/#ListenAndServe)에 따르면 `ListenAndServe` 함수의 1번째 인자인 `handler`에 특정 핸들러가 주어지지 않고 `nil`이면 `DefaultServeMux`가 사용된다고 한다.

### defaultservemux.ql

사실 `listenandserve.ql`가 있으면 본 쿼리는 필요없다. 그냥 작성해 봤다.

아래는 `defaultservemux.ql` 코드이다.

```ql
import go

from Variable defaultservemux
where defaultservemux.hasQualifiedName("net/http", "DefaultServeMux")
select defaultservemux.getAReference(), defaultservemux.getAReference().getFile()
```

Golang의 `net/http` 패키지에 속하는 `DefaultServeMux` 변수를 사용하는 곳을 찾는다.

전체 코드에서 `http.DefaultServeMux`라는 문자열을 검색하는 것과 다름없다.
