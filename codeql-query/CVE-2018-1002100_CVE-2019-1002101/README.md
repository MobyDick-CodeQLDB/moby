# CVE-2018-1002100 & CVE-2019-1002101

CVE-2019-1002101은 1.11.9, 1.12.7, 1.13.5, 1.14.0 버전에서 패치되었다.

따라서 본 쿼리는 CVE 적용 가능한 버전인 1.11.9, 1.12.7, 1.13.5, 1.14.0 이전 버전에서 1-day 탐지가 가능하도록 작성하였다.

참고한 LGTM 예시 쿼리 (거의 그대로 가져옴)

- [Arbitrary file write during zip extraction ("zip slip")](https://lgtm.com/rules/1510350386114/)
- [Uncontrolled data used in path expression](https://lgtm.com/rules/1510366186013/)

참고한 Security Lab 문서

- [Creating path queries](https://help.semmle.com/QL/learn-ql/writing-queries/path-queries.html)
- [About data flow analysis](https://help.semmle.com/QL/learn-ql/intro-to-data-flow.html)
- [Predicates](https://help.semmle.com/QL/ql-handbook/predicates.html)
- [Expressions - Aggregations](https://help.semmle.com/QL/ql-handbook/expressions.html#aggregations)
- [CodeQL library for Go](https://help.semmle.com/QL/learn-ql/go/introduce-libraries-go.html)


### What is it?

`zip-slip.ql`: zip이나 tar 파일 압축 해제 시 발생 가능한 destination 파일의 경로에 대한 path traversal을 탐지한다. (zip slip 취약점)

`path-injection.ql`: 사용자가 영향을 줄 수 있는 경로에 접근하는 로직 존재 시 unexpected 리소스에 접근 가능하다. 이를 탐지한다. (일반적인 path traversal 취약점)

## Query Explanation

### zip-slip.ql

아래는 `zip-slip.ql` 코드이다.

```ql
import go
import semmle.go.security.ZipSlip::ZipSlip
import DataFlow::PathGraph

from Configuration cfg, DataFlow::PathNode source, DataFlow::PathNode sink
where cfg.hasFlowPath(source, sink)
select source, sink, source.getNode().getFile()
```

`DataFlow::PathNode`를 사용하기 위해 `DataFlow::PathGraph`를 import 한다.

`Configuration`은 `source`에서 `sink`로 데이터가 어떻게 흐르는지 정의하는 predicate를 포함하는 class이다.

`semmle.go.security.ZipSlip::ZipSlip`는 `Configuration`를 상속받아 zip slip 취약점을 검증하도록 구현된 라이브러리이다. codeql-go GitHub의 [ZipSlip.qll](https://github.com/github/codeql-go/blob/main/ql/src/semmle/go/security/ZipSlip.qll)에서 확인할 수 있다.

`select` 문을 통해 `source`, `sink`, 그리고 `source`가 위치한 파일의 경로를 출력한다.

### path-injection.ql

본 쿼리는 CVE에 해당하는 쿼리는 아니지만, 확장적으로 사용할 수 있을 것 같아 추가하였다.

아래는 `path-injection.ql` 코드이다.

```ql
import go
import semmle.go.security.TaintedPath::TaintedPath
import DataFlow::PathGraph

from Configuration cfg, DataFlow::PathNode source, DataFlow::PathNode sink
where cfg.hasFlowPath(source, sink)
select source, sink, source.getNode().getFile()
```

`semmle.go.security.TaintedPath::TaintedPath`는 `Configuration`를 상속받아 path traversal 취약점을 검증하도록 구현된 라이브러리이다. codeql-go GitHub의 [TaintedPath.qll](https://github.com/github/codeql-go/blob/main/ql/src/semmle/go/security/TaintedPath.qll)에서 확인할 수 있다.
